# Nextest configuration for fortress-rollback
# See: https://nexte.st/book/configuration.html

# Test groups for tests that share UDP ports
# These tests must run serially to avoid port conflicts
[test-groups]
# Tests in sessions::p2p, sessions::p2p_enum, and some spectator tests use ports 7777/8888
port-7777 = { max-threads = 1 }

[profile.default]
# Retry flaky tests once before reporting failure
retries = 1

# Use all available threads for test execution
test-threads = "num-cpus"

# Fail fast by default (stop on first failure)
fail-fast = true

# Show slow tests (helps identify performance issues)
slow-timeout = { period = "30s", terminate-after = 2 }

# Status output during test runs
status-level = "pass"
final-status-level = "flaky"

# Serialize tests that use port 7777 (and 8888)
[[profile.default.overrides]]
filter = 'test(sessions::p2p::) | test(sessions::p2p_enum::)'
test-group = 'port-7777'

# Spectator tests using 7777/8888 (test_start_session and test_synchronize_with_host)
[[profile.default.overrides]]
filter = 'test(sessions::spectator::test_start_session) | test(sessions::spectator::test_synchronize_with_host)'
test-group = 'port-7777'

[profile.default.junit]
# Generate JUnit XML reports for CI integration
path = "target/nextest/default/junit.xml"

# CI profile with more retries and no fail-fast
[profile.ci]
retries = 2
fail-fast = false
slow-timeout = { period = "60s", terminate-after = 3 }

# Profile for debugging flaky tests
[profile.flaky-check]
retries = 10
fail-fast = false
test-threads = 1
