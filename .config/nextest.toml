# Nextest configuration for fortress-rollback
# See: https://nexte.st/book/configuration.html
#
# ZERO TOLERANCE FOR FLAKY TESTS
# All tests must pass on first attempt. If a test fails intermittently,
# it's either a production bug or a test bug that must be fixed.
# Do NOT add retries to mask flakiness.

# Test groups for tests that share UDP ports
# These tests must run serially to avoid port conflicts
[test-groups]
# Tests in sessions::p2p, sessions::p2p_enum, and some spectator tests use ports 7777/8888
port-7777 = { max-threads = 1 }

[profile.default]
# Zero retries - tests must pass first time
retries = 0

# Use all available threads for test execution
test-threads = "num-cpus"

# Fail fast by default (stop on first failure)
fail-fast = true

# Show slow tests (helps identify performance issues)
slow-timeout = { period = "30s", terminate-after = 2 }

# Status output during test runs
status-level = "pass"

# Serialize tests that use port 7777 (and 8888)
[[profile.default.overrides]]
filter = 'test(sessions::p2p::) | test(sessions::p2p_enum::)'
test-group = 'port-7777'

# Spectator tests using 7777/8888 (test_start_session and test_synchronize_with_host)
[[profile.default.overrides]]
filter = 'test(sessions::spectator::test_start_session) | test(sessions::spectator::test_synchronize_with_host)'
test-group = 'port-7777'

# Multi-process network tests need longer timeouts because they:
# 1. Spawn external peer processes
# 2. Simulate hostile network conditions (high packet loss, burst loss)
# 3. May need multiple sync attempts before establishing connection
# Tests using stress_test preset need up to 180s (60s sync timeout + overhead)
[[profile.default.overrides]]
filter = 'test(network::multi_process::)'
slow-timeout = { period = "60s", terminate-after = 4 }  # Max 240s for extreme scenarios

[profile.default.junit]
# Generate JUnit XML reports for CI integration
path = "target/nextest/default/junit.xml"

# CI profile - same zero-tolerance policy
[profile.ci]
retries = 0
fail-fast = false  # Run all tests to see full failure picture
slow-timeout = { period = "60s", terminate-after = 3 }
