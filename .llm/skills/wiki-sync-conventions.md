# Wiki Sync Conventions — Preventing Link Format Bugs

> **This document covers the conventions that prevent docs/ → wiki/ link format mismatches.**
> The most common bug: using `(architecture.md)` in wiki/ instead of `(Architecture)`.

## Quick Reference

| Context | Link format | Example |
|---------|-------------|---------|
| `docs/` files | Lowercase with `.md` extension | `[Guide](user-guide.md)` |
| `wiki/` files | PascalCase, **no** extension | `[Guide](User-Guide)` |
| `wiki/_Sidebar.md` | PascalCase, **no** extension | `[User Guide](User-Guide)` |
| External (non-docs) | Full GitHub URL | `[Code](https://github.com/.../blob/main/src/lib.rs)` |

---

## Rule 1: Wiki Files Are Generated — Never Edit Directly

All files in `wiki/` are generated by `scripts/sync-wiki.py` from `docs/`.

```
docs/user-guide.md  ──sync-wiki.py──▶  wiki/User-Guide.md
docs/architecture.md  ──────────────▶  wiki/Architecture.md
docs/index.md  ─────────────────────▶  wiki/Home.md
```

**If a wiki file has wrong content or broken links, fix the source in `docs/` and re-run sync.** Do not patch `wiki/` directly — the next sync overwrites it.

Each generated wiki file includes a comment header identifying its source:

```markdown
<!-- SYNC: This file should be kept in sync with docs/user-guide.md -->
```

This comment is a signal: **the file is generated, not authored.**

---

## Rule 2: Wiki Links Are Extensionless PascalCase

GitHub Wiki resolves page links without file extensions. The `sync-wiki.py` script transforms links automatically:

| `docs/` source | `wiki/` output |
|-----------------|----------------|
| `(user-guide.md)` | `(User-Guide)` |
| `(architecture.md)` | `(Architecture)` |
| `(architecture.md#section)` | `(Architecture#section)` |
| `(specs/formal-spec.md)` | `(Formal-Specification)` |
| `(../CHANGELOG.md)` | Full GitHub blob URL |

### The Bug This Prevents

A docs/ file correctly links to `architecture.md` (the file exists at `docs/architecture.md`). If this link leaks into wiki/ without transformation, it becomes a broken link because:

- Wiki has no `architecture.md` page — the page is named `Architecture`
- GitHub Wiki expects `(Architecture)`, not `(architecture.md)`

**This is exactly what happened:** `wiki/User-Guide.md` contained `[Architecture Guide](architecture.md)` instead of `[Architecture Guide](Architecture)`.

### Root Causes

1. **Manual wiki edit** — Someone edited `wiki/User-Guide.md` directly instead of `docs/user-guide.md`
2. **Sync script bug** — The link transformer missed a link (e.g., inside a code fence, edge case regex)
3. **Missing WIKI_STRUCTURE entry** — The target file has no mapping, so auto-generated name may be wrong

---

## Rule 3: The WIKI_STRUCTURE Mapping

The `WIKI_STRUCTURE` dict in `scripts/sync-wiki.py` maps docs/ filenames to wiki page names:

```python
WIKI_STRUCTURE = {
    "index.md": "Home",
    "user-guide.md": "User-Guide",
    "architecture.md": "Architecture",
    "migration.md": "Migration",
    "changelog.md": "Changelog",
    "contributing.md": "Contributing",
    "code-of-conduct.md": "Code-of-Conduct",
    "fortress-vs-ggrs.md": "Fortress-vs-GGRS",
    "specs/formal-spec.md": "Formal-Specification",
    # ... etc
}
```

**When adding a new docs/ page:**

1. Create `docs/new-page.md`
2. Add `"new-page.md": "New-Page"` to `WIKI_STRUCTURE`
3. Add a sidebar entry in `generate_sidebar()`
4. Run `python3 scripts/sync-wiki.py`
5. Run `python3 scripts/check-wiki-consistency.py`

If a file is missing from `WIKI_STRUCTURE`, the script auto-generates a name via `path_to_wiki_name()` (capitalize each hyphen-separated segment). This fallback works for simple cases but should not be relied upon — always add an explicit mapping.

---

## Rule 4: The Sync Pipeline

### How It Works

```
docs/*.md
    │
    ▼
sync-wiki.py
    ├── Strip MkDocs frontmatter
    ├── Convert admonitions (!!! → blockquotes)
    ├── Convert tabbed content (=== → headings)
    ├── Remove Material icons (:material-*:, :octicons-*:)
    ├── Remove grid cards (<div class="grid cards">)
    ├── Convert links (*.md → PascalCase extensionless)
    ├── Adjust asset paths (../assets/ → assets/)
    ├── Convert external links (../ escaping docs → GitHub URLs)
    ├── Add SYNC comment header
    └── Generate _Sidebar.md
    │
    ▼
wiki/*.md
```

### How Link Conversion Works

The `convert_links()` function in `sync-wiki.py`:

1. Parses all `[text](href)` links in the content
2. Skips links inside code fences and inline code spans
3. Skips external URLs, anchors, and special protocols
4. Resolves relative paths from the source file location
5. Looks up the resolved path in `WIKI_STRUCTURE`
6. Replaces with `[text](WikiPageName)` (no `.md` extension)
7. Preserves anchor fragments: `(Architecture#section)`

Links that escape the `docs/` directory (e.g., `../CHANGELOG.md`) are converted to full GitHub blob URLs.

---

## Rule 5: Validation Tools

Three scripts catch wiki issues before they reach users:

### `scripts/check-links.sh`

General-purpose link validation across all markdown files. Catches broken relative paths and missing targets.

```bash
./scripts/check-links.sh          # Standard run
./scripts/check-links.sh --verbose # Show all checked links
```

### `scripts/validate-wiki-output.py`

Validates generated wiki content for rendering issues:

- Indented code fences (render as preformatted blocks on GitHub Wiki)
- Orphaned admonition content (unconverted MkDocs syntax)
- Raw MkDocs syntax that was not stripped
- Missing or broken wiki links

```bash
python3 scripts/validate-wiki-output.py
python3 scripts/validate-wiki-output.py --strict  # Fail on warnings too
```

### `scripts/check-wiki-consistency.py`

Cross-validates the entire wiki pipeline:

- Sidebar links point to existing wiki pages
- All `docs/` files are mapped in `WIKI_STRUCTURE`
- All wiki pages have sidebar entries
- No special characters in wiki-link display text

```bash
python3 scripts/check-wiki-consistency.py
python3 scripts/check-wiki-consistency.py --verbose
```

### Recommended Validation Sequence

After any docs/ or sync script change:

```bash
python3 scripts/sync-wiki.py
python3 scripts/check-wiki-consistency.py
python3 scripts/validate-wiki-output.py
./scripts/check-links.sh
```

---

## Rule 6: Common Mistakes

### Mistake: Manually Editing wiki/ Files

```bash
# ❌ WRONG — will be overwritten by next sync
vim wiki/User-Guide.md

# ✅ CORRECT — edit the source, then sync
vim docs/user-guide.md
python3 scripts/sync-wiki.py
```

### Mistake: Using .md Extensions in Wiki Links

```markdown
<!-- ❌ WRONG — broken on GitHub Wiki -->
See the [Architecture Guide](architecture.md) for details.

<!-- ✅ CORRECT — extensionless PascalCase -->
See the [Architecture Guide](Architecture) for details.
```

This mistake typically happens when someone copies a link from `docs/` into `wiki/` without transforming it.

### Mistake: Forgetting WIKI_STRUCTURE Entry

Adding `docs/new-feature.md` without updating `WIKI_STRUCTURE` causes `check-wiki-consistency.py` to report:

```
ERROR: docs/new-feature.md is not mapped in WIKI_STRUCTURE
```

### Mistake: Mismatched Sidebar and Page Names

The sidebar link target must exactly match the wiki filename (without `.md`):

```markdown
<!-- ❌ WRONG — case mismatch -->
- [User Guide](user-guide)

<!-- ✅ CORRECT — matches wiki/User-Guide.md -->
- [User Guide](User-Guide)
```

---

## Rule 7: How to Fix Wiki Issues

### Issue Is in Content or Links

1. Identify the source file from the `<!-- SYNC: ... -->` header
2. Fix the issue in `docs/` (not `wiki/`)
3. Run `python3 scripts/sync-wiki.py`
4. Verify the fix in `wiki/`

### Issue Is in the Sync Script

1. Fix the transformation logic in `scripts/sync-wiki.py`
2. Re-run sync: `python3 scripts/sync-wiki.py`
3. Add a test case if possible (the script has a test suite)
4. Run all validation scripts

### Issue Is Wiki-Only (Not From docs/)

Some wiki files may have wiki-specific content (e.g., `_Sidebar.md`). Edit these cautiously and run `check-wiki-consistency.py` after.

---

## See Also

- [github-wiki-sync.md](github-wiki-sync.md) — MkDocs conversion patterns, page naming, sidebar syntax
- [markdown-link-validation.md](markdown-link-validation.md) — General markdown link validation
- [documentation-code-consistency.md](documentation-code-consistency.md) — Keeping docs and code in sync
