name: Fortress Rollback CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:


env:
  CARGO_TERM_COLOR: always

jobs:
  # Validate GitHub Actions workflows and YAML files
  validate-yaml:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate YAML files
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}}}" \
            .github/workflows/*.yml \
            docker/docker-compose.yml \
            .pre-commit-config.yaml

      - name: Install actionlint
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv actionlint /usr/local/bin/

      - name: Validate GitHub Actions workflows
        run: actionlint

  # Markdown linting and link checking
  markdown-lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          markdownlint --config .markdownlint.json \
            '**/*.md' \
            --ignore 'target/**' \
            --ignore 'fuzz/target/**' \
            --ignore 'loom-tests/target/**' \
            --ignore 'node_modules/**'

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      - name: Check markdown links
        run: |
          find . -name '*.md' \
            -not -path './target/*' \
            -not -path './fuzz/target/*' \
            -not -path './loom-tests/target/*' \
            -not -path './node_modules/*' \
            -exec markdown-link-check --config .markdown-link-check.json {} \;
        continue-on-error: true  # Warn but don't fail - external links may be temporarily unavailable

  # MSRV (Minimum Supported Rust Version) verification
  # Ensures Cargo.toml rust-version matches Dockerfile and project actually builds
  msrv-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract MSRV from Cargo.toml
        id: cargo-msrv
        run: |
          MSRV=$(grep -E '^rust-version\s*=' Cargo.toml | sed 's/.*"\([^"]*\)".*/\1/')
          echo "msrv=$MSRV" >> "$GITHUB_OUTPUT"
          echo "Cargo.toml MSRV: $MSRV"

      - name: Extract Rust version from Dockerfile
        id: docker-rust
        run: |
          DOCKER_RUST=$(grep -E '^FROM rust:' docker/Dockerfile | sed 's/FROM rust:\([0-9.]*\).*/\1/')
          echo "docker_rust=$DOCKER_RUST" >> "$GITHUB_OUTPUT"
          echo "Dockerfile Rust: $DOCKER_RUST"

      - name: Verify MSRV matches Dockerfile
        run: |
          CARGO_MSRV="${{ steps.cargo-msrv.outputs.msrv }}"
          DOCKER_RUST="${{ steps.docker-rust.outputs.docker_rust }}"

          if [ "$CARGO_MSRV" != "$DOCKER_RUST" ]; then
            echo "❌ ERROR: MSRV mismatch!"
            echo "  Cargo.toml rust-version: $CARGO_MSRV"
            echo "  Dockerfile Rust version: $DOCKER_RUST"
            echo ""
            echo "The Dockerfile Rust version must match the Cargo.toml rust-version."
            echo "Update either docker/Dockerfile or Cargo.toml to fix this."
            exit 1
          fi

          echo "✅ MSRV versions match: $CARGO_MSRV"

      - name: Install MSRV toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ steps.cargo-msrv.outputs.msrv }}

      - name: Verify build with MSRV
        run: cargo check --all-targets
        env:
          RUSTUP_TOOLCHAIN: ${{ steps.cargo-msrv.outputs.msrv }}

  # Supply chain security check using cargo-deny
  # Checks for security advisories, banned licenses, and dependency issues
  supply-chain-security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check advisories
        run: cargo deny check advisories

      - name: Check licenses
        run: cargo deny check licenses

      - name: Check bans
        run: cargo deny check bans

      - name: Check sources
        run: cargo deny check sources

  build:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Update rust
        run: rustup update stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: build-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            build-${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --verbose
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

      - name: Run tests (nextest)
        run: cargo nextest run --profile ci --verbose
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

      - name: Build docs
        run: cargo doc --verbose

      - name: Check formatting
        run: cargo fmt --check

  check-wasm:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install stable wasm toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: wasm-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            wasm-${{ runner.os }}-cargo-

      - name: Check wasm
        run: cargo check --target wasm32-unknown-unknown --features wasm-bindgen
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

  miri:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install nightly with Miri
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: miri

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: miri-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            miri-${{ runner.os }}-cargo-

      - name: Setup Miri
        run: cargo miri setup

      - name: Run Miri tests (library)
        run: cargo miri test --lib -- --skip property_tests
        env:
          MIRIFLAGS: "-Zmiri-disable-isolation"

  # Multi-process network tests (localhost)
  network-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: network-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            network-${{ runner.os }}-cargo-

      - name: Build network test peer
        run: cargo build --release --bin network_test_peer
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

      - name: Run multi-process network tests (nextest)
        run: cargo nextest run --profile ci --release -E 'test(multi_process)' --test network
        timeout-minutes: 10
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

  # Docker-based network tests with tc/netem
  docker-network-tests:
    runs-on: ubuntu-latest
    needs: [build, msrv-check]  # Ensure MSRV is verified before Docker build

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose -f docker/docker-compose.yml build

      - name: Run Docker network tests (quick)
        run: ./scripts/docker-network-tests.sh --quick
        timeout-minutes: 15

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-network-test-results
          path: test-results/
          retention-days: 7

  # TLA+ Model Checking
  tla-verification:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache TLA+ tools
        uses: actions/cache@v4
        with:
          path: .tla-tools
          key: tla-tools-v1.8.0

      - name: Run TLA+ verification
        run: ./scripts/verify-tla.sh --fail-fast
        timeout-minutes: 30

  # Z3 SMT Solver Verification
  z3-verification:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: z3-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            z3-${{ runner.os }}-cargo-

      - name: Install Z3 library
        run: sudo apt-get update && sudo apt-get install -y libz3-dev

      - name: Run Z3 verification tests (nextest)
        run: cargo nextest run --profile ci --test verification --features z3-verification -E 'test(z3)'
        timeout-minutes: 10
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

  # Kani Formal Verification (Tier 1 - Fast proofs)
  kani-verification-tier1:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.66.0-${{ runner.os }}

      - name: Install Kani
        run: |
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani verification (Tier 1 - Fast)
        run: ./scripts/verify-kani.sh --quick --tier 1 --fail-fast --verbose
        timeout-minutes: 15

  # Kani Formal Verification (Tier 2 - Medium proofs)
  kani-verification-tier2:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.66.0-${{ runner.os }}

      - name: Install Kani
        run: |
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani verification (Tier 2 - Medium)
        run: ./scripts/verify-kani.sh --quick --tier 2 --fail-fast
        timeout-minutes: 30

  # Kani Formal Verification (Tier 3 - Slow proofs)
  kani-verification-tier3:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.66.0-${{ runner.os }}

      - name: Install Kani
        run: |
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani verification (Tier 3 - Slow)
        run: ./scripts/verify-kani.sh --quick --tier 3 --fail-fast
        timeout-minutes: 45

  package-dry-run:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4
      - name: Ensure crate is publishable (dry-run)
        run: cargo publish --dry-run

  # Semver compatibility check - detect accidental breaking changes
  semver-checks:
    runs-on: ubuntu-latest
    # Only run on PRs to catch breaking changes before merge
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cargo-semver-checks
        uses: taiki-e/install-action@cargo-semver-checks

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: semver-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            semver-${{ runner.os }}-cargo-

      - name: Check semver compatibility
        run: cargo semver-checks check-release
        continue-on-error: true  # Warn but don't fail - breaking changes are acceptable if documented
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

  # Feature flag combinations check
  feature-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cargo-hack
        uses: taiki-e/install-action@cargo-hack

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: feature-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            feature-${{ runner.os }}-cargo-

      - name: Check feature powerset (excluding slow features)
        run: cargo hack check --feature-powerset --exclude-features z3-verification,z3-verification-bundled,graphical-examples
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

  # Unsafe code audit via cargo-geiger
  unsafe-audit:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cargo-geiger
        run: cargo install cargo-geiger --locked

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: geiger-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            geiger-${{ runner.os }}-cargo-

      - name: Audit unsafe code in dependencies
        run: cargo geiger --all-features --lib 2>&1 | tee geiger-report.txt || true
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

      - name: Verify no unsafe in library code
        run: |
          # Check that our library has 0 unsafe usage
          if grep -E "^[0-9]+/[0-9]+ .* fortress-rollback" geiger-report.txt | grep -v "0/0"; then
            echo "ERROR: Unsafe code detected in fortress-rollback library!"
            exit 1
          fi
          echo "✓ No unsafe code in fortress-rollback library"

  # Unused dependencies check
  unused-deps:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install nightly toolchain (required for udeps)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Install cargo-udeps
        uses: taiki-e/install-action@cargo-udeps

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: udeps-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            udeps-${{ runner.os }}-cargo-

      - name: Check for unused dependencies
        run: cargo +nightly udeps --all-targets
        continue-on-error: true  # Warn but don't fail build
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"

  # Markdown code sample verification
  markdown-code-verification:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: mdcode-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            mdcode-${{ runner.os }}-cargo-

      - name: Verify markdown code samples compile
        run: ./scripts/verify-markdown-code.sh --fail-fast
        continue-on-error: true  # Warn but don't fail - documentation may have intentionally incomplete examples
        env:
          RUSTC_WRAPPER: sccache
          SCCACHE_GHA_ENABLED: "true"
