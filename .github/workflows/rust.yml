name: Fortress Rollback CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:


env:
  CARGO_TERM_COLOR: always

jobs:
  # Validate GitHub Actions workflows and YAML files
  validate-yaml:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate YAML files
        run: |
          yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}}}" \
            .github/workflows/*.yml \
            docker/docker-compose.yml \
            .pre-commit-config.yaml

      - name: Install actionlint
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv actionlint /usr/local/bin/

      - name: Validate GitHub Actions workflows
        run: actionlint

  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3
      - name: Update rust
        run: rustup update stable
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose
      - name: Build docs
        run: cargo doc --verbose
      - name: Check formatting
        run: cargo fmt --check

  check-wasm:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Install stable wasm toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
      - name: Check wasm
        run: cargo check --target wasm32-unknown-unknown --features wasm-bindgen

  miri:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Install nightly with Miri
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: miri
      - name: Setup Miri
        run: cargo miri setup
      - name: Run Miri tests (library)
        run: cargo miri test --lib -- --skip property_tests
        env:
          MIRIFLAGS: "-Zmiri-disable-isolation"

  # Multi-process network tests (localhost)
  network-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v3
      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - name: Build network test peer
        run: cargo build --release --bin network_test_peer
      - name: Run multi-process network tests
        run: cargo test --release --test network -- multi_process --test-threads=1
        timeout-minutes: 10

  # Docker-based network tests with tc/netem
  docker-network-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose -f docker/docker-compose.yml build

      - name: Run Docker network tests (quick)
        run: ./scripts/docker-network-tests.sh --quick
        timeout-minutes: 15

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-network-test-results
          path: test-results/
          retention-days: 7

  # TLA+ Model Checking
  tla-verification:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache TLA+ tools
        uses: actions/cache@v4
        with:
          path: .tla-tools
          key: tla-tools-v1.8.0

      - name: Run TLA+ verification
        run: ./scripts/verify-tla.sh
        timeout-minutes: 30

  # Z3 SMT Solver Verification
  z3-verification:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v3

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install Z3 build dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libclang-dev

      - name: Cache Z3 build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/debug/.fingerprint/*z3*
            target/debug/build/*z3*
            target/debug/deps/*z3*
          key: z3-bundled-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}

      - name: Run Z3 verification tests
        run: cargo test --test verification --features z3-verification -- z3 --verbose
        timeout-minutes: 15

  # Kani Formal Verification (Tier 1 - Fast proofs)
  kani-verification-tier1:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.66.0-${{ runner.os }}

      - name: Install Kani
        run: |
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani verification (Tier 1 - Fast)
        run: ./scripts/verify-kani.sh --quick --tier 1
        timeout-minutes: 5

  # Kani Formal Verification (Tier 2 - Medium proofs)
  kani-verification-tier2:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.66.0-${{ runner.os }}

      - name: Install Kani
        run: |
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani verification (Tier 2 - Medium)
        run: ./scripts/verify-kani.sh --quick --tier 2
        timeout-minutes: 10

  # Kani Formal Verification (Tier 3 - Slow proofs)
  kani-verification-tier3:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly

      - name: Cache Kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.66.0-${{ runner.os }}

      - name: Install Kani
        run: |
          if ! command -v cargo-kani &> /dev/null; then
            cargo install --locked kani-verifier
            cargo kani setup
          fi

      - name: Run Kani verification (Tier 3 - Slow)
        run: ./scripts/verify-kani.sh --quick --tier 3
        timeout-minutes: 15

  package-dry-run:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v3
      - name: Ensure crate is publishable (dry-run)
        run: cargo publish --dry-run
